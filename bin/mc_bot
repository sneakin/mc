#!/bin/env ruby

require 'mc'
require 'mc/request'
require 'mc/bot'
require 'mc/bot_gui'

host = 'li172-212.members.linode.com'
nick = ARGV[0] || 'Bot'
admins = %W(SneakyDean)

socket = TCPSocket.new(host, 25565)
connection = MC::Connection.new(socket)
bot = MC::Bot.new(nick, connection, admins)
bot.connect

if bot.needs_session?
  $stdout.write("Password: ")
  pass = $stdin.readline.strip
  session = MC::Session.new(nick, pass)
  session.join_server(bot.connection_hash)
end

bot.login

gui = MC::BotGui.new(bot)

packets = 0
starting = Time.now
ending = Time.now
rate = 20
done = false

Signal.trap("INT") do
  done = true
end

begin
  starting = Time.now
  packets = bot.process_packets

  ending = Time.now
  packet_rate = 1.0 / (ending - starting)

  gui.packets = packets
  gui.packet_rate = packet_rate
  gui.update
end until done

puts "Bye"
